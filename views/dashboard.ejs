<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Vendor Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'DM Sans', sans-serif; 
            background: #f0f2f5; 
            color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* --- Input Section --- */
        .card-panel { 
            background: white; 
            padding: 24px; 
            border-radius: 24px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 100%;
            max-width: 450px; 
            margin-bottom: 20px;
        }

        h2 { margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }

        .setting-group {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        
        label { font-weight: 500; font-size: 0.9rem; color: #4b5563; display: block; margin-bottom: 5px; }

        input[type="text"], select, input[type="file"] { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; 
            margin-bottom: 10px; font-size: 0.95rem; outline: none;
        }

        button { 
            width: 100%; padding: 16px; border-radius: 12px; border: none; 
            font-weight: 700; cursor: pointer; transition: transform 0.2s, background 0.2s;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

        /* --- Swipe Stack Section --- */
        #resultArea { width: 100%; max-width: 450px; display: none; }

        .stack-container {
            height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-top: 10px;
            perspective: 1000px;
        }

        .product-card {
            position: absolute;
            width: 300px;
            height: 420px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            overflow: hidden;
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .product-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        .card-info {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.85));
            color: white;
        }

        /* --- Controls --- */
        .queue-controls { text-align: center; margin-top: 20px; }
        .wa-btn { background: #25D366; color: white; font-size: 1.1rem; box-shadow: 0 4px 14px rgba(37, 211, 102, 0.4); }
        
        #loading { 
            display: none; text-align: center; font-weight: 600; color: #007bff; padding: 20px; 
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

<div class="card-panel">
    <h2>ðŸ“¸ AI E-com Studio</h2>
    <form id="bulkForm">
        <div class="setting-group">
            <div class="toggle-row">
                <span>âœ¨ Remove Background</span>
                <input type="checkbox" id="removeBgToggle" checked style="width: 20px; height: 20px;">
            </div>
            <label>Watermark Text (Optional)</label>
            <input type="text" id="watermarkInput" placeholder="e.g. @MyBrand">
        </div>

        <label>Studio Background Theme</label>
        <select name="bgColor" id="bgColor">
            <option value="white">Pristine White</option>
            <option value="black">Premium Black</option>
            <option value="#f8bbd0">Soft Pink</option>
            <option value="#e0e0e0">Light Grey</option>
            <option value="#fff9c4">Warm Cream</option>
        </select>

        <label>Select Product Photos</label>
        <input type="file" id="fileInput" name="files" multiple required accept="image/*">
        
        <div id="priceInputs"></div>
        <button type="submit" class="btn-primary" id="uploadBtn">Generate & Enhance</button>
    </form>
    <div id="loading">AI is polishing your products...</div>
</div>

<div id="resultArea">
    <div class="stack-container" id="cardStack"></div>
    
    <div class="queue-controls">
        <h4 id="queueText" style="margin-bottom: 15px; color: #64748b;"></h4>
        <button class="wa-btn" id="shareBtn" onclick="postCurrent()">Post Top Card to Status ðŸš€</button>
        <p style="margin-top: 15px; font-size: 0.8rem; color: #94a3b8;">Swipe card to skip â€¢ Button to Share</p>
    </div>
</div>

<script>
    let uploadQueue = [];
    let currentIndex = 0;
    let isDragging = false;
    let startX = 0;

    // Handle price input generation
    document.getElementById('fileInput').onchange = (e) => {
        const container = document.getElementById('priceInputs');
        container.innerHTML = '';
        Array.from(e.target.files).forEach((file, i) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'prices';
            input.placeholder = `Price for ${file.name}`;
            input.required = true;
            container.appendChild(input);
        });
    };

    // Form Submission
    document.getElementById('bulkForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('uploadBtn');
        const loader = document.getElementById('loading');
        
        btn.disabled = true;
        loader.style.display = 'block';

        const formData = new FormData(e.target);
        formData.append('removeBg', document.getElementById('removeBgToggle').checked);
        formData.append('watermarkText', document.getElementById('watermarkInput').value);

        try {
            const res = await fetch('/upload-bulk', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (data.success) {
                uploadQueue = data.items;
                currentIndex = 0;
                document.querySelector('.card-panel').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                renderStack();
                updateUI();
            }
        } catch (err) {
            alert("Upload failed. Check console.");
        } finally {
            loader.style.display = 'none';
            btn.disabled = false;
        }
    };

    function renderStack() {
        const container = document.getElementById('cardStack');
        container.innerHTML = '';
        
        // Show current + next 2 for visual depth
        const itemsToShow = uploadQueue.slice(currentIndex, currentIndex + 3);
        
        itemsToShow.reverse().forEach((item, i) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // Visual stack offset
            const reverseIdx = itemsToShow.length - 1 - i;
            card.style.zIndex = i;
            card.style.transform = `translateY(${reverseIdx * 10}px) scale(${1 - (reverseIdx * 0.04)})`;
            
            card.innerHTML = `
                <img src="${item.previewUrl}">
                <div class="card-info">
                    <h3>Price: ${item.price}</h3>
                </div>
            `;
            
            if (reverseIdx === 0) initSwipe(card);
            container.appendChild(card);
        });
    }

    function initSwipe(el) {
        el.onmousedown = el.ontouchstart = (e) => {
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            el.style.transition = 'none';
        };

        document.onmousemove = document.ontouchmove = (e) => {
            if (!isDragging) return;
            const moveX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX) - startX;
            el.style.transform = `translateX(${moveX}px) rotate(${moveX / 15}deg)`;
        };

        document.onmouseup = document.ontouchend = (e) => {
            if (!isDragging) return;
            isDragging = false;
            const endX = (e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX) - startX;

            if (Math.abs(endX) > 120) {
                el.style.transition = 'transform 0.4s ease-in';
                el.style.transform = `translateX(${endX > 0 ? 1000 : -1000}px) rotate(${endX / 5}deg)`;
                setTimeout(nextItem, 300);
            } else {
                el.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                el.style.transform = 'translateX(0) rotate(0)';
            }
        };
    }

    function nextItem() {
        currentIndex++;
        if (currentIndex < uploadQueue.length) {
            renderStack();
            updateUI();
        } else {
            document.getElementById('resultArea').innerHTML = "<div class='card-panel' style='text-align:center;'><h2>âœ… All Set!</h2><p>Your WhatsApp Status is going to look amazing.</p><button onclick='location.reload()' class='btn-primary' style='margin-top:20px;'>Upload More</button></div>";
        }
    }

    function postCurrent() {
        const item = uploadQueue[currentIndex];
        const text = encodeURIComponent(`Price: ${item.price}\n\nCheck it out here: ${item.link}`);
        window.open(`https://wa.me/?text=${text}`);
        nextItem();
    }

    function updateUI() {
        document.getElementById('queueText').innerText = `Product ${currentIndex + 1} of ${uploadQueue.length}`;
    }
</script>

</body>
</html>
