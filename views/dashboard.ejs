<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#f5f5f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title><%= (typeof store !== 'undefined' && store && store.name) ? store.name : 'Studio' %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-bg: #d7cede;
            --surface: #f8f6fb;
            --surface-secondary: #f0ecf7;
            --separator: rgba(53,38,78,0.1);
            --text: #271f35;
            --text-secondary: #6c6180;
            --text-tertiary: #8f84a3;
            --tint: #6a59eb;
            --green: #34c759;
            --radius: 20px;
            --radius-sm: 12px;
            --radius-lg: 20px;
            --tab-height: 52px;
            --header-height: 48px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Outfit', sans-serif;
            background: radial-gradient(120% 90% at 50% -10%, #efe9f7 0%, #ded5ea 42%, #d4cbe2 100%);
            color: var(--text);
            min-height: 100%;
            min-height: 100dvh;
            padding-bottom: calc(var(--tab-height) + env(safe-area-inset-bottom));
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 10;
            height: calc(var(--header-height) + env(safe-area-inset-top));
            padding-top: env(safe-area-inset-top);
            padding-left: 20px;
            padding-right: 20px;
            background: var(--app-bg);
            display: flex;
            align-items: center;
            border-bottom: 0.5px solid var(--separator);
        }
        .app-title { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }
        .app-content { padding: 14px 16px 20px; max-width: 480px; margin: 0 auto; }
        .list-group {
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
        }
        .list-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.04em;
            padding: 16px 16px 6px;
        }
        .list-group-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin: -2px 0 8px;
            padding: 0 4px;
        }
        .studio-mode-tabs {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid rgba(70, 51, 108, 0.12);
            background: rgba(255, 255, 255, 0.56);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
            max-width: 100%;
        }
        .studio-mode-tab {
            border: none;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
        }
        .studio-mode-tab.active {
            color: var(--text);
            background: #fff;
            box-shadow: 0 6px 12px rgba(44, 31, 69, 0.12);
        }
        .studio-pane {
            display: none;
        }
        .studio-pane.active {
            display: block;
        }
        .list-row {
            min-height: 44px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 0.5px solid var(--separator);
        }
        .list-row:last-child { border-bottom: none; }
        .list-row-file { overflow: hidden; }
        .file-input-overlay {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            font-size: 0;
        }
        .list-row .row-icon { width: 20px; height: 20px; color: var(--text-tertiary); flex-shrink: 0; }
        .list-row label { font-size: 15px; color: var(--text); flex: 1; min-width: 0; }
        .list-row input[type="text"] {
            flex: 1;
            min-width: 0;
            border: none;
            background: transparent;
            font-size: 15px;
            color: var(--text);
            text-align: right;
            outline: none;
        }
        .list-row input[type="text"]::placeholder { color: var(--text-tertiary); }
        .list-row .app-select {
            flex: 1;
            min-width: 0;
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.74);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            font-family: inherit;
            padding: 9px 34px 9px 12px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236c6180' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px 12px;
        }
        .list-row .app-select:focus,
        .list-row .app-select:focus-visible {
            outline: none;
            box-shadow: none;
            border-color: transparent;
        }
        .switch-wrap {
            width: 51px;
            height: 31px;
            border-radius: 31px;
            background: var(--separator);
            position: relative;
            flex-shrink: 0;
        }
        .switch-wrap:has(input:checked) { background: var(--green); }
        .switch-wrap input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            margin: 0;
        }
        .switch-wrap::after {
            content: '';
            position: absolute;
            width: 27px;
            height: 27px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            pointer-events: none;
        }
        .switch-wrap:has(input:checked)::after { transform: translateX(20px); }
        .option-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .option-chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            background: var(--surface-secondary);
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s, color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .option-chip:active { opacity: 0.9; }
        .option-chip.selected {
            background: var(--tint);
            color: #fff;
        }
        .audio-library-panel {
            padding: 0 16px 14px;
        }
        .audio-library-toolbar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        .audio-segment {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid rgba(70, 51, 108, 0.12);
            background: rgba(255, 255, 255, 0.55);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
            width: fit-content;
        }
        .audio-segment-btn {
            border: none;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            cursor: pointer;
            font-family: inherit;
        }
        .audio-segment-btn.active {
            color: var(--text);
            background: #fff;
            box-shadow: 0 6px 12px rgba(44, 31, 69, 0.12);
        }
        .audio-search-input {
            width: 100%;
            border: 1px solid rgba(69, 50, 105, 0.14);
            background: rgba(255, 255, 255, 0.78);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--text);
            outline: none;
        }
        .audio-search-input::placeholder {
            color: var(--text-tertiary);
        }
        .audio-library-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .audio-library-list {
            display: flex;
            flex-direction: column;
            gap: 9px;
        }
        .audio-track-card {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            padding: 9px;
            border: 1px solid rgba(62, 44, 96, 0.13);
            background: linear-gradient(145deg, #ffffff 0%, #f7f3fc 58%, #ece3f8 100%);
            box-shadow: 0 10px 20px rgba(43, 28, 67, 0.12);
        }
        .audio-track-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(80% 120% at 90% -20%, rgba(130, 104, 219, 0.25), transparent 60%);
            pointer-events: none;
        }
        .audio-track-top {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .audio-track-cover {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 8px 14px rgba(24, 16, 39, 0.18);
            flex-shrink: 0;
        }
        .audio-track-meta {
            flex: 1;
            min-width: 0;
        }
        .audio-track-title {
            font-size: 13px;
            font-weight: 700;
            line-height: 1.2;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .audio-track-sub {
            margin-top: 1px;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .audio-rank-badge {
            flex-shrink: 0;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.01em;
            color: #fff;
            padding: 3px 8px;
            border-radius: 999px;
            background: linear-gradient(135deg, #6a59eb 0%, #8f79ff 100%);
            box-shadow: 0 8px 14px rgba(64, 46, 118, 0.26);
        }
        .audio-track-actions {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 7px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .audio-track-link {
            font-size: 11px;
            font-weight: 600;
            text-decoration: none;
            color: #5f4be2;
        }
        .audio-track-use {
            margin-left: auto;
        }
        .audio-track-player {
            position: relative;
            z-index: 1;
            width: 100%;
            margin-top: 6px;
            height: 30px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.7);
        }
        .audio-empty {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px 2px;
        }
        .audio-toggle-btn {
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .audio-toggle-label {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .audio-toggle-caret {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            transition: transform 0.18s ease;
        }
        .audio-toggle-btn.open .audio-toggle-caret {
            transform: rotate(180deg);
        }
        .list-row-options .option-row { margin-left: auto; }
        .list-group .price-row { border-bottom: 0.5px solid var(--separator); }
        .list-group .price-row:last-child { border-bottom: none; }
        .price-row {
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 40px;
            padding: 8px 16px;
        }
        .thumb-preview { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; background: var(--surface-secondary); }
        .price-row input { flex: 1; border: none; background: transparent; font-size: 15px; outline: none; }
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px 18px;
            margin-top: 6px;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            background: var(--tint);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }
        .btn-primary .icon { width: 18px; height: 18px; }
        .btn-primary:active { opacity: 0.85; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        #loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* Result screen Ã¢â‚¬â€œ full screen card stack */
        #resultArea {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 20;
            background: var(--app-bg);
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(var(--tab-height) + env(safe-area-inset-bottom));
        }
        #resultArea .app-content { flex: 1; display: flex; flex-direction: column; padding: 0; max-width: 100%; }
        .immersive-stage {
            position: relative;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 0 24px;
        }
        .result-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.04em;
            margin-bottom: 2px;
        }
        .result-count {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .progress-dots { display: flex; justify-content: flex-start; gap: 5px; margin-bottom: 0; }
        .progress-dots span { width: 6px; height: 6px; border-radius: 50%; background: rgba(93,74,242,0.25); transition: all 0.2s; }
        .progress-dots span.active { background: var(--tint); transform: scale(1.15); }
        .stack-wrapper {
            position: relative;
            width: 90vw;
            max-width: 90vw;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0 0 110px;
            touch-action: pan-y;
        }
        .stack-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            aspect-ratio: 9 / 16;
            transform: translateX(-14px);
            overflow: visible;
            margin-left: 14px;
        }
        .card-stack-layers { position: absolute; inset: 0; overflow: visible; }
        .product-card {
            position: absolute;
            left: 0; top: 0;
            width: 100%;
            height: 100%;
            background: var(--surface);
            border-radius: 24px;
            border: 1px solid rgba(53,38,78,0.08);
            box-shadow: 0 14px 30px rgba(41,27,64,0.14);
            overflow: hidden;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
            transition: box-shadow 0.24s ease, transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1);
            will-change: transform;
        }
        .product-card.dragging { transition: none; cursor: grabbing; box-shadow: 0 18px 32px rgba(41,27,64,0.2); }
        .product-card.stack-2 {
            transform: translate3d(34px, 12px, 0) scale(0.95, 0.915);
            z-index: 0;
            box-shadow: 0 9px 16px rgba(41,27,64,0.16);
            border-color: rgba(53,38,78,0.16);
            filter: brightness(0.98) saturate(0.96);
        }
        .product-card.stack-3 {
            transform: translate3d(62px, 24px, 0) scale(0.9, 0.83);
            z-index: -1;
            box-shadow: 0 7px 12px rgba(41,27,64,0.14);
            border-color: rgba(53,38,78,0.2);
            filter: brightness(0.94) saturate(0.9);
        }
        .product-card.stack-2, .product-card.stack-3 { transition: transform 0.28s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.24s ease; }
        .product-card .card-image-fill {
            position: absolute;
            inset: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #eee8f4 0%, #e5deef 100%);
        }
        .product-card .card-image-fill .card-image-bg,
        .product-card .card-image-fill .card-image-main {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
        }
        .product-card .card-image-fill .card-image-bg {
            object-fit: cover;
            object-position: center;
            filter: blur(20px) saturate(1.06);
            transform: scale(1.08);
            opacity: 0.52;
        }
        .product-card .card-image-fill .card-image-main {
            object-fit: contain;
            object-position: center;
        }
        .product-card .card-image-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(
                180deg,
                rgba(24, 17, 38, 0.08) 0%,
                rgba(24, 17, 38, 0.02) 34%,
                rgba(24, 17, 38, 0.24) 100%
            );
        }
        .card-top-row {
            position: absolute;
            top: 18px;
            left: 18px;
            right: 18px;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: none;
        }
        .card-label {
            display: inline-flex;
            align-items: center;
            padding: 7px 10px;
            min-height: 30px;
            border: 1px solid rgba(110, 131, 160, 0.7);
            background: rgba(244, 246, 249, 0.75);
            color: #1b2434;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.01em;
            border-radius: 0;
        }
        .card-label.is-empty {
            visibility: hidden;
        }
        .card-heart {
            width: 24px;
            height: 24px;
            color: #1b2434;
            opacity: 0.94;
        }
        .card-bottom-meta {
            position: absolute;
            left: 18px;
            right: 18px;
            bottom: 18px;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 2px;
            pointer-events: none;
        }
        .card-price-inline {
            font-size: 42px;
            line-height: 1;
            font-weight: 800;
            color: #f4f7fb;
            text-shadow: 0 2px 14px rgba(16, 20, 31, 0.45);
            letter-spacing: -0.04em;
        }
        .card-name-inline {
            font-size: 15px;
            font-weight: 500;
            color: rgba(246, 248, 252, 0.94);
            text-shadow: 0 1px 10px rgba(16, 20, 31, 0.45);
            letter-spacing: -0.01em;
        }
        .stack-overlay {
            position: absolute;
            inset: 0;
            z-index: 12;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0;
            pointer-events: none;
            border-radius: 24px;
            background: linear-gradient(180deg, rgba(28,20,44,0) 56%, rgba(28,20,44,0.09) 100%);
        }
        .stack-header {
            pointer-events: none;
            transform: translateY(0);
            padding: 14px 0 0 2px;
            margin-bottom: 8px;
        }
        .stack-footer { pointer-events: auto; transform: translateY(calc(100% + 12px)); }
        .card-details { margin-top: 0; padding: 0 2px; pointer-events: none; }
        .card-title { font-size: 40px; line-height: 1; font-weight: 700; color: var(--text); letter-spacing: -0.03em; }
        .card-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        .action-row { display: flex; gap: 8px; margin-top: 10px; }
        .action-row button {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 9px 10px;
            min-height: 40px;
            border-radius: 14px;
            border: 1px solid rgba(44,30,66,0.12);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.16s ease, opacity 0.2s;
            pointer-events: auto;
            box-shadow: 0 2px 6px rgba(41,27,64,0.08);
        }
        .action-row button .icon { width: 16px; height: 16px; }
        .action-row button:active { opacity: 0.88; transform: translateY(1px); }
        .btn-copy { background: rgba(255,255,255,0.72); color: var(--text-secondary); }
        .wa-btn { background: rgba(44,197,106,0.16); color: #2c8652; border-color: rgba(44,197,106,0.34); }
        .btn-cart { background: rgba(45,125,245,0.14); color: #2e5ea8; border-color: rgba(45,125,245,0.32); }
        .tab-item-wrap { position: relative; }
        .cart-tab-badge { position: absolute; top: -2px; right: 50%; margin-right: -28px; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: 600; color: #fff; background: var(--tint); border-radius: 9px; display: inline-flex; align-items: center; justify-content: center; }
        .copy-toast {
            position: fixed;
            left: 20px; right: 20px;
            bottom: calc(var(--tab-height) + env(safe-area-inset-bottom) + 12px);
            background: var(--text);
            color: #fff;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.25s, transform 0.25s;
            z-index: 100;
            pointer-events: none;
        }
        .copy-toast.show { opacity: 1; transform: translateY(0); }

        /* Tab bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--tab-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background: rgba(255,255,255,0.92);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--separator);
            display: flex;
            z-index: 50;
        }
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            text-decoration: none;
            color: var(--text-tertiary);
            font-size: 10px;
            font-weight: 500;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-item.active { color: var(--tint); }
        .tab-item svg { width: 22px; height: 22px; }
        .tab-item.active svg { stroke: var(--tint); }
    </style>
</head>
<body>

<header class="app-header" style="justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:10px;min-width:0;">
        <% if (typeof store !== 'undefined' && store && store.logoUrl) { %>
        <img src="<%= store.logoUrl %>" alt="Store logo" style="width:30px;height:30px;border-radius:9px;border:1px solid rgba(53,38,78,0.14);background:#fff;object-fit:contain;padding:3px;flex-shrink:0;">
        <% } %>
        <h1 class="app-title"><%= (typeof store !== 'undefined' && store && store.name) ? store.name : 'Studio' %></h1>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
        <% if (typeof storePath !== 'undefined' && storePath) { %>
        <a href="<%= storePath %>" style="font-size:13px;font-weight:500;color:var(--tint);text-decoration:none;">Storefront</a>
        <% } %>
        <a href="/logout?next=/products" style="font-size:13px;font-weight:500;color:var(--text-secondary);text-decoration:none;">Log out</a>
    </div>
</header>

<main class="app-content">
    <% if (typeof storeError === 'string' && storeError) { %>
    <div style="background:rgba(254,242,242,0.9);color:#b91c1c;padding:12px 14px;border-radius:12px;margin-bottom:12px;font-size:13px;"><%= storeError %></div>
    <% } %>
    <% if (typeof store !== 'undefined' && store && typeof storeLink !== 'undefined' && storeLink) { %>
    <p class="list-group-title">Store</p>
    <div class="list-group">
        <div class="list-row">
            <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3.92-3.92a5 5 0 00-7.07-7.07l-1.24 1.24"/><path d="M14 11a5 5 0 00-7.54-.54L2.54 14.38a5 5 0 107.07 7.07l1.24-1.24"/></svg>
            <label style="min-width:88px;">Share link</label>
            <input type="text" readonly value="<%= storeLink %>" id="storeLinkInput">
        </div>
        <div class="list-row" style="justify-content:flex-end;gap:10px;">
            <button type="button" class="option-chip selected" onclick="copyStoreLink()">Copy link</button>
            <a href="<%= storePath %>" class="option-chip selected" style="text-decoration:none;">Open store</a>
        </div>
        <div class="list-row" style="align-items:flex-start;gap:14px;">
            <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3 6 6 .9-4.5 4.4 1.1 6.2L12 16.8 6.4 19.5l1.1-6.2L3 8.9 9 8z"/></svg>
            <label style="min-width:88px;">Brand logo</label>
            <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;flex:1;min-width:0;flex-wrap:wrap;">
                <% if (store.logoUrl) { %>
                <img src="<%= store.logoUrl %>" alt="Store logo" style="width:38px;height:38px;border-radius:10px;border:1px solid var(--separator);background:#fff;object-fit:contain;padding:4px;">
                <% } else { %>
                <span style="font-size:12px;color:var(--text-secondary);">No logo selected</span>
                <% } %>
                <a href="/onboarding/logo?manage=1" class="option-chip selected" style="text-decoration:none;">Change logo</a>
            </div>
        </div>
    </div>
    <% } %>
    <div class="studio-mode-tabs" role="tablist" aria-label="Studio modes">
        <button type="button" class="studio-mode-tab active" id="studioModeUpload" role="tab" aria-selected="true">Upload products</button>
        <button type="button" class="studio-mode-tab" id="studioModeVideo" role="tab" aria-selected="false">Generate video</button>
    </div>
    <form id="bulkForm">
        <section class="studio-pane active" data-pane="upload" role="tabpanel" aria-labelledby="studioModeUpload">
        <p class="list-group-title">Product setup</p>
        <p class="list-group-subtitle">Set background, badge, and default product details for this upload batch.</p>
        <div class="list-group">
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                <label>Remove background</label>
                <span class="switch-wrap"><input type="checkbox" id="removeBgToggle" checked></span>
            </div>
            <div class="list-row list-row-options">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.82-.14 2.66-.4"/><path d="M22 12c0-5.5-4.5-10-10-10"/></svg>
                <label>Background</label>
                <input type="hidden" name="bgColor" id="bgColor" value="white">
                <div class="option-row" role="group" aria-label="Background color">
                    <button type="button" class="option-chip selected" data-target="bgColor" data-value="white">White</button>
                    <button type="button" class="option-chip" data-target="bgColor" data-value="black">Black</button>
                    <button type="button" class="option-chip" data-target="bgColor" data-value="#f8bbd0">Pink</button>
                </div>
            </div>
            <div class="list-row list-row-options">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V7a2 2 0 00-2-2h-2V3a1 1 0 00-1-1H9a1 1 0 00-1 1v2H6a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2v-2"/><rect x="8" y="9" width="8" height="6" rx="1"/><path d="M12 9V6"/></svg>
                <label>Badge</label>
                <input type="hidden" name="badgeLabel" id="badgeLabel" value="">
                <div class="option-row" role="group" aria-label="Badge label">
                    <button type="button" class="option-chip selected" data-target="badgeLabel" data-value="">None</button>
                    <button type="button" class="option-chip" data-target="badgeLabel" data-value="NEW">New</button>
                    <button type="button" class="option-chip" data-target="badgeLabel" data-value="SALE">Sale</button>
                    <button type="button" class="option-chip" data-target="badgeLabel" data-value="LIMITED">Limited</button>
                </div>
            </div>
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/><rect x="8" y="8" width="8" height="8"/></svg>
                <label>Category</label>
                <select name="categoryId" id="categorySelect" class="app-select">
                    <option value="">None</option>
                </select>
            </div>
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><path d="M3 6h18M16 10a4 4 0 01-8 0"/></svg>
                <label>Details (optional)</label>
                <div class="detail-fields" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                    <input type="text" id="productSize" placeholder="Size" style="max-width:80px;">
                    <input type="text" id="productColor" placeholder="Color" style="max-width:100px;">
                    <input type="text" id="productQty" placeholder="Qty" style="max-width:70px;">
                </div>
            </div>
        </div>
        <p class="list-group-title">Categories</p>
        <p class="list-group-subtitle">Create category names first so products and videos can be grouped quickly.</p>
        <div class="list-group">
            <div class="list-row" style="flex-wrap:wrap;">
                <input type="text" id="newCategoryName" placeholder="New category name" style="flex:1;min-width:120px;border:1px solid var(--separator);border-radius:8px;padding:8px 12px;font-size:14px;">
                <button type="button" class="option-chip selected" id="addCategoryBtn">Add</button>
            </div>
            <div id="categoryList" class="category-list" style="padding:0 16px 12px;font-size:13px;color:var(--text-secondary);"></div>
        </div>
        </section>
        <section class="studio-pane" data-pane="video" role="tabpanel" aria-labelledby="studioModeVideo">
        <p class="list-group-title">Category video</p>
        <p class="list-group-subtitle">Use this after product links are generated and categories are filled.</p>
        <div class="list-group">
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                <label>Category</label>
                <select id="videoCategorySelect" class="app-select">
                    <option value="">Select category</option>
                </select>
            </div>
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 18h18"/><path d="M3 6h18"/><path d="M7 6v12"/><path d="M17 6v12"/></svg>
                <label>Transition</label>
                <select id="videoTransitionSelect" class="app-select">
                    <option value="fade">Fade</option>
                    <option value="cut">Cut (no transition)</option>
                    <option value="slideleft">Slide left</option>
                    <option value="slideright">Slide right</option>
                    <option value="wipeleft">Wipe left</option>
                    <option value="wiperight">Wipe right</option>
                    <option value="dissolve">Dissolve</option>
                </select>
            </div>
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                <label>Audio URL</label>
                <input type="text" id="videoAudioUrl" placeholder="https://.../track.mp3">
            </div>
            <div class="list-row" style="flex-wrap:wrap;align-items:flex-start;gap:8px;">
                <div style="display:flex;flex-wrap:wrap;gap:8px;width:100%;">
                    <button type="button" class="option-chip audio-toggle-btn" id="audioLibraryBtn" aria-expanded="false" aria-controls="audioLibraryPanel" aria-label="Toggle songs">
                        <span class="audio-toggle-label">Naija hits</span>
                        <svg class="audio-toggle-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <button type="button" class="option-chip" id="audioLibraryRefreshBtn">Refresh songs</button>
                    <button type="button" class="option-chip" id="clearAudioBtn">Clear audio</button>
                </div>
                <span id="selectedAudioLabel" style="font-size:12px;color:var(--text-secondary);width:100%;">No song selected</span>
            </div>
            <div id="audioLibraryPanel" class="audio-library-panel" style="display:none;">
                <div class="audio-library-toolbar">
                    <div class="audio-segment" role="tablist" aria-label="Song list">
                        <button type="button" class="audio-segment-btn active" id="audioTabHottest" role="tab" aria-selected="true">Hottest</button>
                        <button type="button" class="audio-segment-btn" id="audioTabLatest" role="tab" aria-selected="false">Latest</button>
                        <button type="button" class="audio-segment-btn" id="audioTabThrowback" role="tab" aria-selected="false">Throwback 2010s</button>
                    </div>
                    <input type="text" id="audioSearchInput" class="audio-search-input" placeholder="Search by title or artist">
                </div>
                <div id="audioLibraryStatus" class="audio-library-status"></div>
                <div id="audioLibraryList" class="audio-library-list"></div>
            </div>
            <div class="list-row">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
                <label>Transition sec</label>
                <input type="text" id="videoTransitionDuration" value="0.5" inputmode="decimal" placeholder="0.5">
            </div>
            <div class="list-row" style="flex-wrap:wrap;gap:8px;">
                <button type="button" class="option-chip selected" id="generateVideoBtn">Generate video</button>
                <span id="videoStatus" style="font-size:13px;color:var(--text-secondary);"></span>
            </div>
            <div id="videoResult" style="padding:0 16px 12px;display:none;">
                <a id="videoResultLink" href="#" target="_blank" rel="noopener" style="font-size:14px;color:var(--tint);font-weight:600;">Open video</a>
            </div>
        </div>
        </section>
        <section class="studio-pane active" data-pane="upload" role="tabpanel" aria-labelledby="studioModeUpload">
        <p class="list-group-title">Media and links</p>
        <p class="list-group-subtitle">Upload photos/videos, set prices, and generate all product links in one go.</p>
        <div class="list-group">
            <label class="list-row list-row-file" style="cursor:pointer;position:relative;">
                <svg class="row-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                <span style="font-size:15px;color:var(--text);">Select photos or videos</span>
                <input type="file" id="fileInput" name="files" multiple required accept="image/*,video/*" class="file-input-overlay">
            </label>
            <div id="priceInputs"></div>
        </div>
        <button type="submit" class="btn-primary" id="uploadBtn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/><path d="M5 21l2-6 4 2-2 6"/><path d="M19 21l-2-6-4 2 2 6"/></svg>
            Generate links
        </button>
        </section>
    </form>
    <div id="loading">Processing...</div>
</main>

<div id="resultArea">
    <main class="app-content">
        <div class="immersive-stage">
            <div class="stack-wrapper">
                <div class="stack-container">
                    <div class="card-stack-layers" id="cardStack"></div>
                    <div class="stack-overlay">
                        <div class="stack-header">
                            <p class="result-label">Your items</p>
                            <p class="result-count" id="resultSubtitle"><span id="queueCount">0</span> items</p>
                            <div class="progress-dots" id="progressDots"></div>
                        </div>
                        <div class="stack-footer">
                            <div class="card-details">
                                <div class="card-subtitle" id="cardSubtitle">Scroll or swipe to browse. Tap Share to post in bulk.</div>
                            </div>
                            <div class="action-row">
                                <button type="button" class="btn-copy" onclick="copyCurrent()">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                    Copy
                                </button>
                                <button type="button" class="wa-btn" onclick="shareNextStatus()">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                                    Share
                                </button>
                                <button type="button" class="btn-cart" onclick="addCurrentToCart()">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
                                    Add to cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="copy-toast" id="copyToast">Link copied</div>
</div>

<nav class="tab-bar">
    <a href="/" class="tab-item active" aria-current="page">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        <span>Studio</span>
    </a>
    <a href="/products" class="tab-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><path d="M3 6h18M16 10a4 4 0 01-8 0"/></svg>
        <span>Products</span>
    </a>
    <a href="/cart" class="tab-item tab-item-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
        <span>Cart</span>
        <span class="cart-tab-badge" id="cartTabBadge" style="display:none;">0</span>
    </a>
</nav>

<script>
    const storeFrontLink = <%- JSON.stringify(typeof storeLink !== 'undefined' ? storeLink : '') %>;
    let categories = [];

    async function loadCategories() {
        try {
            const res = await fetch('/api/categories', { credentials: 'same-origin' });
            if (res.ok) {
                categories = await res.json();
                renderCategorySelect();
                renderCategoryList();
            }
        } catch (e) { /* ignore */ }
    }
    function renderCategorySelect() {
        const sel = document.getElementById('categorySelect');
        const videoSel = document.getElementById('videoCategorySelect');
        if (sel) {
            const current = sel.value;
            sel.innerHTML = '<option value="">None</option>';
            categories.forEach(function(c) {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
            if (current && categories.some(function(c) { return c.id === current; })) sel.value = current;
        }
        if (videoSel) {
            const vCur = videoSel.value;
            videoSel.innerHTML = '<option value="">Select category</option>';
            categories.forEach(function(c) {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                videoSel.appendChild(opt);
            });
            if (vCur && categories.some(function(c) { return c.id === vCur; })) videoSel.value = vCur;
        }
    }
    function renderCategoryList() {
        const el = document.getElementById('categoryList');
        if (!el) return;
        if (categories.length === 0) {
            el.innerHTML = '<span style="opacity:0.7;">No categories yet. Add one above.</span>';
            return;
        }
        el.innerHTML = categories.map(function(c) {
            return '<span class="category-chip" style="display:inline-block;margin:2px 4px 2px 0;padding:4px 8px;background:var(--surface-secondary);border-radius:8px;">' + escapeHtml(c.name) + '</span>';
        }).join('');
    }
    function copyStoreLink() {
        if (!storeFrontLink) return;
        const toast = document.getElementById('copyToast');
        const canToast = !!(toast && toast.offsetParent !== null);
        navigator.clipboard.writeText(storeFrontLink).then(function() {
            if (canToast) {
                toast.textContent = 'Store link copied';
                toast.classList.add('show');
                setTimeout(function() { toast.classList.remove('show'); }, 1800);
            } else {
                alert('Store link copied');
            }
        }).catch(function() {
            if (canToast) {
                toast.textContent = 'Copy failed';
                toast.classList.add('show');
                setTimeout(function() { toast.classList.remove('show'); }, 1800);
            } else {
                alert('Copy failed');
            }
        });
    }

    let uploadQueue = [];
    let currentIndex = 0;
    let drag = {
        active: false,
        startX: 0,
        currentX: 0,
        renderedX: 0,
        lastX: 0,
        lastMoveTime: 0,
        velocityX: 0,
        startTime: 0,
        raf: null
    };
    const backCards = { second: null, third: null };
    let wheelLock = false;
    let scrollNavBound = false;
    const SWIPE_THRESHOLD = 58;
    const VELOCITY_THRESHOLD = 0.3; // px/ms
    const THROW_MULT = 1.2;
    const MAX_ROTATE = 10;

    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }

    loadCategories();

    (function setupStudioModeTabs() {
        const uploadTab = document.getElementById('studioModeUpload');
        const videoTab = document.getElementById('studioModeVideo');
        const panes = Array.from(document.querySelectorAll('.studio-pane[data-pane]'));
        if (!uploadTab || !videoTab || !panes.length) return;

        function setMode(mode) {
            const nextMode = mode === 'video' ? 'video' : 'upload';
            uploadTab.classList.toggle('active', nextMode === 'upload');
            uploadTab.setAttribute('aria-selected', nextMode === 'upload' ? 'true' : 'false');
            videoTab.classList.toggle('active', nextMode === 'video');
            videoTab.setAttribute('aria-selected', nextMode === 'video' ? 'true' : 'false');
            panes.forEach(function(pane) {
                const isActive = pane.getAttribute('data-pane') === nextMode;
                pane.classList.toggle('active', isActive);
            });
        }

        uploadTab.addEventListener('click', function() { setMode('upload'); });
        videoTab.addEventListener('click', function() { setMode('video'); });
        setMode('upload');
    })();

    (function setupVideoGenerator() {
        const btn = document.getElementById('generateVideoBtn');
        const sel = document.getElementById('videoCategorySelect');
        const transitionSel = document.getElementById('videoTransitionSelect');
        const audioInput = document.getElementById('videoAudioUrl');
        const transitionDurationInput = document.getElementById('videoTransitionDuration');
        const audioLibraryBtn = document.getElementById('audioLibraryBtn');
        const audioLibraryRefreshBtn = document.getElementById('audioLibraryRefreshBtn');
        const clearAudioBtn = document.getElementById('clearAudioBtn');
        const selectedAudioLabel = document.getElementById('selectedAudioLabel');
        const audioLibraryPanel = document.getElementById('audioLibraryPanel');
        const audioLibraryStatus = document.getElementById('audioLibraryStatus');
        const audioLibraryList = document.getElementById('audioLibraryList');
        const audioTabHottest = document.getElementById('audioTabHottest');
        const audioTabLatest = document.getElementById('audioTabLatest');
        const audioTabThrowback = document.getElementById('audioTabThrowback');
        const audioSearchInput = document.getElementById('audioSearchInput');
        const statusEl = document.getElementById('videoStatus');
        const resultEl = document.getElementById('videoResult');
        const resultLink = document.getElementById('videoResultLink');
        if (!btn || !sel || !statusEl || !resultEl || !resultLink) return;

        const defaultButtonLabel = btn.textContent;

        let pollInterval = null;
        let audioPanelOpen = false;
        let audioTracksLoading = false;
        let audioCollections = { hottest: [], latest: [], throwback: [] };
        let activeAudioBucket = 'hottest';
        const PINNED_THROWBACK_MATCH = {
            titleIncludes: 'good feeling',
            artistIncludes: 'flo rida'
        };

        function setButtonBusy(isBusy) {
            btn.disabled = isBusy;
            btn.textContent = isBusy ? 'Generating...' : defaultButtonLabel;
        }
        function setVideoStatus(message, type) {
            statusEl.textContent = message || '';
            if (type === 'error') {
                statusEl.style.color = '#b42318';
                return;
            }
            if (type === 'success') {
                statusEl.style.color = '#12703a';
                return;
            }
            statusEl.style.color = 'var(--text-secondary)';
        }
        function setAudioButtonsBusy(isBusy) {
            if (audioLibraryBtn) audioLibraryBtn.disabled = isBusy;
            if (audioLibraryRefreshBtn) audioLibraryRefreshBtn.disabled = isBusy;
        }
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
        function formatDuration(seconds) {
            const n = Number(seconds);
            if (!Number.isFinite(n) || n <= 0) return '';
            const total = Math.round(n);
            const mins = Math.floor(total / 60);
            const secs = total % 60;
            return mins + ':' + String(secs).padStart(2, '0');
        }
        function formatReleaseDate(value) {
            if (!value) return '';
            const date = new Date(value);
            if (isNaN(date.getTime())) return '';
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }
        function parseReleaseYear(value) {
            if (!value) return 0;
            const date = new Date(value);
            if (isNaN(date.getTime())) return 0;
            return date.getUTCFullYear();
        }
        function isPinnedThrowbackTrack(track) {
            if (!track) return false;
            const title = String(track.title || '').toLowerCase();
            const artist = String(track.artist || '').toLowerCase();
            return title.includes(PINNED_THROWBACK_MATCH.titleIncludes) && artist.includes(PINNED_THROWBACK_MATCH.artistIncludes);
        }
        function isFreshRelease(value) {
            if (!value) return false;
            const date = new Date(value);
            if (isNaN(date.getTime())) return false;
            const ageMs = Date.now() - date.getTime();
            return ageMs >= 0 && ageMs <= (35 * 24 * 60 * 60 * 1000);
        }
        function mapItunesFallbackTrack(item, index) {
            if (!item || !item.previewUrl || !/^https?:\/\//i.test(item.previewUrl)) return null;
            const releaseDate = item.releaseDate || '';
            return {
                id: String(item.trackId || item.collectionId || item.previewUrl),
                title: item.trackName || item.collectionName || 'Untitled',
                artist: item.artistName || 'Unknown artist',
                album: item.collectionName || '',
                previewUrl: item.previewUrl,
                artworkUrl: (item.artworkUrl100 || item.artworkUrl60 || item.artworkUrl30 || '').replace(/\/\d+x\d+bb\.(png|jpg)$/i, '/600x600bb.$1'),
                pageUrl: item.trackViewUrl || item.collectionViewUrl || item.artistViewUrl || '',
                releaseDate: releaseDate,
                releaseYear: parseReleaseYear(releaseDate),
                durationSeconds: Number.isFinite(Number(item.trackTimeMillis)) ? Math.round(Number(item.trackTimeMillis) / 1000) : null,
                rank: index + 1,
                source: 'iTunes Search (Client)'
            };
        }
        async function fetchClientItunesFallback(searchTerm, limit, options) {
            try {
                const query = new URLSearchParams();
                query.set('term', searchTerm || 'nigeria top songs');
                query.set('country', (options && options.country) ? String(options.country).toUpperCase() : 'NG');
                query.set('entity', 'song');
                query.set('limit', String(limit || 16));
                const res = await fetch('https://itunes.apple.com/search?' + query.toString(), { cache: 'no-store' });
                const data = await res.json();
                const rows = Array.isArray(data && data.results) ? data.results : [];
                const sourceLabel = (options && options.sourceLabel) ? String(options.sourceLabel) : 'iTunes Search (Client)';
                return rows.map(function(item, idx) {
                    const track = mapItunesFallbackTrack(item, idx);
                    if (!track) return null;
                    track.source = sourceLabel;
                    return track;
                }).filter(Boolean);
            } catch (e) {
                return [];
            }
        }
        function getAllTracks() {
            const merged = [];
            const seen = new Set();
            ['hottest', 'latest', 'throwback'].forEach(function(bucket) {
                (audioCollections[bucket] || []).forEach(function(track) {
                    if (!track || !track.previewUrl) return;
                    const key = track.id || track.previewUrl;
                    if (seen.has(key)) return;
                    seen.add(key);
                    merged.push(track);
                });
            });
            return merged;
        }
        function getVisibleTracks() {
            const tracks = Array.isArray(audioCollections[activeAudioBucket]) ? audioCollections[activeAudioBucket] : [];
            const tokens = String((audioSearchInput && audioSearchInput.value) || '')
                .toLowerCase()
                .trim()
                .split(/\s+/)
                .filter(Boolean)
                .slice(0, 4);
            if (!tokens.length) return tracks;
            return tracks.filter(function(track) {
                const haystack = ((track.title || '') + ' ' + (track.artist || '') + ' ' + (track.album || '')).toLowerCase();
                return tokens.every(function(token) { return haystack.includes(token); });
            });
        }
        async function ensurePinnedThrowbackTrack() {
            if ((audioCollections.throwback || []).some(function(track) { return isPinnedThrowbackTrack(track); })) {
                return;
            }
            const fallbackTracks = await fetchClientItunesFallback('Flo Rida Good Feeling', 15, {
                country: 'US',
                sourceLabel: 'Featured Throwback'
            });
            const pinnedTrack = fallbackTracks.find(function(track) { return isPinnedThrowbackTrack(track); }) || fallbackTracks[0] || null;
            if (!pinnedTrack) return;
            const key = pinnedTrack.id || pinnedTrack.previewUrl;
            const deduped = (audioCollections.throwback || []).filter(function(track) {
                return (track.id || track.previewUrl) !== key;
            });
            audioCollections.throwback = [pinnedTrack].concat(deduped).slice(0, 25);
        }
        function pauseAudioPreviews(exceptEl) {
            if (!audioLibraryList) return;
            audioLibraryList.querySelectorAll('audio').forEach(function(player) {
                if (player !== exceptEl) player.pause();
            });
        }
        function getSelectedAudioUrl() {
            return (audioInput && audioInput.value ? audioInput.value.trim() : '');
        }
        function updateAudioLibraryButtonState() {
            if (!audioLibraryBtn) return;
            const hasSelectedAudio = !!getSelectedAudioUrl();
            audioLibraryBtn.classList.toggle('selected', audioPanelOpen);
            audioLibraryBtn.classList.toggle('open', audioPanelOpen);
            audioLibraryBtn.setAttribute('aria-expanded', audioPanelOpen ? 'true' : 'false');
            audioLibraryBtn.setAttribute(
                'aria-label',
                audioPanelOpen ? 'Collapse songs' : (hasSelectedAudio ? 'Expand songs to change selection' : 'Expand songs')
            );
        }
        function scrollGenerateButtonIntoView() {
            if (!btn) return;
            setTimeout(function() {
                btn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            }, 120);
        }
        function setSelectedAudioLabelValue(track) {
            const value = getSelectedAudioUrl();
            if (!selectedAudioLabel) {
                updateAudioLibraryButtonState();
                return;
            }
            if (!value) {
                selectedAudioLabel.textContent = 'No song selected';
                updateAudioLibraryButtonState();
                return;
            }
            if (track && track.title) {
                selectedAudioLabel.textContent = 'Selected: ' + track.title + (track.artist ? ' - ' + track.artist : '');
                updateAudioLibraryButtonState();
                return;
            }
            const matched = getAllTracks().find(function(item) {
                return item.previewUrl === value;
            });
            if (matched) {
                selectedAudioLabel.textContent = 'Selected: ' + matched.title + (matched.artist ? ' - ' + matched.artist : '');
            } else {
                selectedAudioLabel.textContent = 'Selected custom audio URL';
            }
            updateAudioLibraryButtonState();
        }
        function updateAudioTabState() {
            if (audioTabHottest) {
                const isActive = activeAudioBucket === 'hottest';
                audioTabHottest.classList.toggle('active', isActive);
                audioTabHottest.setAttribute('aria-selected', isActive ? 'true' : 'false');
            }
            if (audioTabLatest) {
                const isActive = activeAudioBucket === 'latest';
                audioTabLatest.classList.toggle('active', isActive);
                audioTabLatest.setAttribute('aria-selected', isActive ? 'true' : 'false');
            }
            if (audioTabThrowback) {
                const isActive = activeAudioBucket === 'throwback';
                audioTabThrowback.classList.toggle('active', isActive);
                audioTabThrowback.setAttribute('aria-selected', isActive ? 'true' : 'false');
            }
        }
        function showAudioPanel(shouldShow, options) {
            if (!audioLibraryPanel) return;
            audioPanelOpen = !!shouldShow;
            audioLibraryPanel.style.display = audioPanelOpen ? 'block' : 'none';
            updateAudioLibraryButtonState();
            if (!audioPanelOpen) pauseAudioPreviews(null);
            if (!audioPanelOpen && options && options.scrollToGenerate) {
                scrollGenerateButtonIntoView();
            }
        }
        function setAudioStatus(message) {
            if (audioLibraryStatus) audioLibraryStatus.textContent = message;
        }
        function renderAudioTracks() {
            if (!audioLibraryList) return;
            audioLibraryList.innerHTML = '';
            const tracks = getVisibleTracks();
            const selectedUrl = (audioInput && audioInput.value ? audioInput.value.trim() : '');
            if (!tracks.length) {
                const empty = document.createElement('div');
                empty.className = 'audio-empty';
                empty.textContent = audioTracksLoading ? 'Loading songs...' : 'No matching songs right now.';
                audioLibraryList.appendChild(empty);
                return;
            }

            tracks.forEach(function(track, index) {
                const card = document.createElement('div');
                card.className = 'audio-track-card';

                const top = document.createElement('div');
                top.className = 'audio-track-top';

                const cover = document.createElement('img');
                cover.className = 'audio-track-cover';
                cover.src = track.artworkUrl || '';
                cover.alt = (track.title || 'Song') + ' artwork';
                cover.loading = 'lazy';

                const meta = document.createElement('div');
                meta.className = 'audio-track-meta';

                const title = document.createElement('div');
                title.className = 'audio-track-title';
                title.textContent = track.title || 'Untitled';

                const sub = document.createElement('div');
                sub.className = 'audio-track-sub';
                const durationText = formatDuration(track.durationSeconds);
                const releaseText = formatReleaseDate(track.releaseDate);
                const pieces = [];
                if (track.artist) pieces.push(track.artist);
                if (durationText) pieces.push(durationText);
                if (releaseText) pieces.push(releaseText);
                sub.textContent = pieces.join(' â€¢ ') || 'Nigerian chart song';

                meta.appendChild(title);
                meta.appendChild(sub);

                const badge = document.createElement('div');
                badge.className = 'audio-rank-badge';
                if (activeAudioBucket === 'hottest') {
                    const rank = Number(track.rank || 0) || (index + 1);
                    badge.textContent = '#' + rank;
                } else if (activeAudioBucket === 'throwback') {
                    if (isPinnedThrowbackTrack(track)) {
                        badge.textContent = 'PICK';
                    } else {
                        const year = Number(track.releaseYear || parseReleaseYear(track.releaseDate) || 0);
                        badge.textContent = year >= 2010 && year <= 2019 ? String(year) : '2010s';
                    }
                } else {
                    badge.textContent = isFreshRelease(track.releaseDate) ? 'NEW' : 'LATEST';
                }

                top.appendChild(cover);
                top.appendChild(meta);
                top.appendChild(badge);

                const actions = document.createElement('div');
                actions.className = 'audio-track-actions';

                const sourceLink = document.createElement('a');
                sourceLink.className = 'audio-track-link';
                sourceLink.href = track.pageUrl || '#';
                sourceLink.target = '_blank';
                sourceLink.rel = 'noopener';
                sourceLink.textContent = 'Open in Apple Music';
                if (!track.pageUrl) {
                    sourceLink.style.opacity = '0.5';
                    sourceLink.style.pointerEvents = 'none';
                }
                actions.appendChild(sourceLink);

                const useBtn = document.createElement('button');
                useBtn.type = 'button';
                useBtn.className = 'option-chip audio-track-use';
                const isSelected = !!selectedUrl && selectedUrl === track.previewUrl;
                if (isSelected) useBtn.classList.add('selected');
                useBtn.textContent = isSelected ? 'Selected' : 'Use';
                useBtn.addEventListener('click', function() {
                    if (audioInput) audioInput.value = track.previewUrl || '';
                    setSelectedAudioLabelValue(track);
                    renderAudioTracks();
                    setAudioStatus('Song selected. Ready to generate.');
                    showAudioPanel(false, { scrollToGenerate: true });
                });
                actions.appendChild(useBtn);

                const preview = document.createElement('audio');
                preview.className = 'audio-track-player';
                preview.controls = true;
                preview.preload = 'none';
                preview.src = track.previewUrl || '';
                preview.addEventListener('play', function() {
                    pauseAudioPreviews(preview);
                });

                card.appendChild(top);
                card.appendChild(actions);
                card.appendChild(preview);
                audioLibraryList.appendChild(card);
            });
        }
        async function loadAudioTracks(forceRefresh) {
            if (audioTracksLoading) return;
            audioTracksLoading = true;
            setAudioButtonsBusy(true);
            setAudioStatus('Fetching hottest Nigerian songs...');
            renderAudioTracks();
            try {
                const query = new URLSearchParams();
                query.set('limit', '16');
                if (forceRefresh) query.set('refresh', '1');
                const searchTerm = String((audioSearchInput && audioSearchInput.value) || '').trim();
                if (searchTerm.length >= 2) query.set('q', searchTerm);
                query.set('_ts', String(Date.now()));
                let data = null;
                let lastError = null;
                const endpoints = ['/api/hot-naija-songs', '/api/free-audio-tracks'];
                for (const endpoint of endpoints) {
                    try {
                        const res = await fetch(endpoint + '?' + query.toString(), {
                            credentials: 'same-origin',
                            cache: 'no-store'
                        });
                        const body = await res.json();
                        if (!res.ok) {
                            throw new Error(body.error || 'Could not fetch songs');
                        }
                        data = body;
                        break;
                    } catch (err) {
                        lastError = err;
                    }
                }
                if (!data) throw lastError || new Error('Could not fetch songs');

                const hottest = Array.isArray(data.hottestTracks)
                    ? data.hottestTracks
                    : (Array.isArray(data.tracks) ? data.tracks : []);
                const latest = Array.isArray(data.latestTracks)
                    ? data.latestTracks
                    : (Array.isArray(data.tracks) ? data.tracks : []);
                const throwback = Array.isArray(data.nostalgicTracks)
                    ? data.nostalgicTracks
                    : (Array.isArray(data.throwbackTracks) ? data.throwbackTracks : []);
                audioCollections.hottest = hottest.filter(function(track) {
                    const sourceText = String(track && track.source || '');
                    return track
                        && track.previewUrl
                        && /^https?:\/\//i.test(track.previewUrl)
                        && !/internet archive/i.test(sourceText);
                });
                audioCollections.latest = latest.filter(function(track) {
                    const sourceText = String(track && track.source || '');
                    return track
                        && track.previewUrl
                        && /^https?:\/\//i.test(track.previewUrl)
                        && !/internet archive/i.test(sourceText);
                });
                audioCollections.throwback = throwback.filter(function(track) {
                    const sourceText = String(track && track.source || '');
                    return track
                        && track.previewUrl
                        && /^https?:\/\//i.test(track.previewUrl)
                        && !/internet archive/i.test(sourceText);
                });
                if (!audioCollections.throwback.length) {
                    const mergedBase = []
                        .concat(audioCollections.hottest || [])
                        .concat(audioCollections.latest || []);
                    audioCollections.throwback = mergedBase.filter(function(track) {
                        const year = Number(track && (track.releaseYear || parseReleaseYear(track.releaseDate)) || 0);
                        return track && track.previewUrl && year >= 2010 && year <= 2019;
                    }).slice(0, 16);
                }
                if (!audioCollections.throwback.length) {
                    const throwbackTerm = searchTerm
                        ? (searchTerm + ' 2010s throwback')
                        : '2010s throwback hits chris brown flo rida pitbull';
                    const throwbackClientTracks = await fetchClientItunesFallback(throwbackTerm, 18, {
                        country: 'US',
                        sourceLabel: 'iTunes Search (Throwback Client)'
                    });
                    audioCollections.throwback = throwbackClientTracks.filter(function(track) {
                        const year = Number(track && (track.releaseYear || parseReleaseYear(track.releaseDate)) || 0);
                        return track && track.previewUrl && (year === 0 || (year >= 2010 && year <= 2019));
                    }).slice(0, 16);
                }
                if (!audioCollections.hottest.length && !audioCollections.latest.length && !audioCollections.throwback.length) {
                    const fallbackTerm = searchTerm || 'nigeria top songs';
                    const fallbackTracks = await fetchClientItunesFallback(fallbackTerm, 16, { country: 'NG' });
                    audioCollections.hottest = fallbackTracks.slice(0, 16);
                    audioCollections.latest = fallbackTracks
                        .slice()
                        .sort(function(a, b) {
                            return new Date(b.releaseDate || 0).getTime() - new Date(a.releaseDate || 0).getTime();
                        })
                        .slice(0, 16);
                    audioCollections.throwback = fallbackTracks
                        .filter(function(track) {
                            const year = new Date(track.releaseDate || '').getUTCFullYear();
                            return year >= 2010 && year <= 2019;
                        })
                        .slice(0, 16);
                }
                await ensurePinnedThrowbackTrack();

                if (!audioCollections[activeAudioBucket].length) {
                    if (audioCollections.hottest.length) activeAudioBucket = 'hottest';
                    else if (audioCollections.latest.length) activeAudioBucket = 'latest';
                    else activeAudioBucket = 'throwback';
                }
                updateAudioTabState();
                renderAudioTracks();
                const sourceLabel = data.source || (audioCollections.hottest.length ? 'iTunes Search' : 'Song feed');
                const activeCount = getVisibleTracks().length;
                setAudioStatus(sourceLabel + ' â€¢ ' + activeCount + ' songs');
                setSelectedAudioLabelValue(null);
            } catch (e) {
                audioCollections = { hottest: [], latest: [], throwback: [] };
                renderAudioTracks();
                setAudioStatus(e.message || 'Could not fetch songs right now.');
            } finally {
                audioTracksLoading = false;
                setAudioButtonsBusy(false);
            }
        }
        function parseTransitionDuration() {
            const raw = (transitionDurationInput && transitionDurationInput.value ? transitionDurationInput.value : '0.5').trim();
            const parsed = Number(raw);
            if (!Number.isFinite(parsed)) return 0.5;
            return Math.max(0, Math.min(2.5, parsed));
        }
        function syncTransitionDurationState() {
            if (!transitionSel || !transitionDurationInput) return;
            const isCut = transitionSel.value === 'cut';
            transitionDurationInput.disabled = isCut;
            if (isCut) transitionDurationInput.value = '0';
            else if (!Number.isFinite(Number(transitionDurationInput.value)) || Number(transitionDurationInput.value) <= 0) transitionDurationInput.value = '0.5';
        }
        if (transitionSel && transitionDurationInput) {
            transitionSel.addEventListener('change', syncTransitionDurationState);
            syncTransitionDurationState();
        }
        if (audioTabHottest) {
            audioTabHottest.addEventListener('click', function() {
                activeAudioBucket = 'hottest';
                updateAudioTabState();
                renderAudioTracks();
            });
        }
        if (audioTabLatest) {
            audioTabLatest.addEventListener('click', function() {
                activeAudioBucket = 'latest';
                updateAudioTabState();
                renderAudioTracks();
            });
        }
        if (audioTabThrowback) {
            audioTabThrowback.addEventListener('click', function() {
                activeAudioBucket = 'throwback';
                updateAudioTabState();
                renderAudioTracks();
            });
        }
        if (audioSearchInput) {
            audioSearchInput.addEventListener('input', function() {
                renderAudioTracks();
            });
        }
        if (audioInput) {
            audioInput.addEventListener('input', function() {
                setSelectedAudioLabelValue(null);
                renderAudioTracks();
            });
            setSelectedAudioLabelValue(null);
        }
        updateAudioTabState();
        setVideoStatus('', 'default');
        setAudioStatus('Loading songs...');
        loadAudioTracks(false);
        if (audioLibraryBtn) {
            audioLibraryBtn.addEventListener('click', async function() {
                const shouldOpen = !audioPanelOpen;
                showAudioPanel(shouldOpen);
                if (shouldOpen && !audioCollections.hottest.length && !audioCollections.latest.length && !audioCollections.throwback.length) {
                    await loadAudioTracks(false);
                }
            });
        }
        if (audioLibraryRefreshBtn) {
            audioLibraryRefreshBtn.addEventListener('click', async function() {
                showAudioPanel(true);
                await loadAudioTracks(true);
            });
        }
        if (clearAudioBtn) {
            clearAudioBtn.addEventListener('click', function() {
                if (audioInput) audioInput.value = '';
                setSelectedAudioLabelValue(null);
                renderAudioTracks();
            });
        }
        if (sel) {
            sel.addEventListener('change', function() {
                if (sel.value) setVideoStatus('', 'default');
            });
        }

        function pollJob(jobId) {
            stopPolling();
            pollInterval = setInterval(async function() {
                try {
                    const res = await fetch('/api/generate-category-video/' + jobId, { credentials: 'same-origin' });
                    const data = await res.json();
                    if (!res.ok) {
                        setVideoStatus(data.error || 'Error', 'error');
                        stopPolling();
                        setButtonBusy(false);
                        return;
                    }
                    if (data.status === 'pending') {
                        setVideoStatus('Queued...');
                    } else if (data.status === 'processing') {
                        setVideoStatus('Generating... ' + (data.progress || 0) + '%');
                    } else if (data.status === 'completed') {
                        stopPolling();
                        setVideoStatus('Done!', 'success');
                        resultEl.style.display = 'block';
                        resultLink.href = data.videoUrl;
                        resultLink.textContent = 'Open video';
                        setButtonBusy(false);
                    } else if (data.status === 'failed') {
                        stopPolling();
                        setVideoStatus('Failed: ' + (data.error || 'Unknown error'), 'error');
                        setButtonBusy(false);
                    }
                } catch (e) {
                    setVideoStatus('Error checking status', 'error');
                    stopPolling();
                    setButtonBusy(false);
                }
            }, 1500);
        }

        btn.addEventListener('click', async function() {
            const catId = (sel && sel.value) || '';
            if (!catId) {
                setVideoStatus('Please select a category before generating.', 'error');
                if (sel && typeof sel.focus === 'function') sel.focus();
                return;
            }
            const transitionType = (transitionSel && transitionSel.value) ? transitionSel.value : 'fade';
            const fadeDuration = transitionType === 'cut' ? 0 : parseTransitionDuration();
            const audioUrl = (audioInput && audioInput.value ? audioInput.value : '').trim();
            setButtonBusy(true);
            setVideoStatus('Starting...');
            resultEl.style.display = 'none';
            try {
                const payload = {
                    categoryId: catId,
                    transitionType: transitionType,
                    fadeDuration: fadeDuration
                };
                if (audioUrl) payload.audioUrl = audioUrl;
                const res = await fetch('/api/generate-category-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (!res.ok) {
                    setVideoStatus(data.error || 'Failed to start', 'error');
                    setButtonBusy(false);
                    return;
                }
                setVideoStatus('Queued...');
                pollJob(data.jobId);
            } catch (e) {
                setVideoStatus('Request failed', 'error');
                setButtonBusy(false);
            }
        });
    })();
    document.getElementById('addCategoryBtn').addEventListener('click', async function() {
        const input = document.getElementById('newCategoryName');
        const name = (input && input.value || '').trim();
        if (!name) return;
        try {
            const res = await fetch('/api/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name }),
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (res.ok) {
                categories.push(data);
                renderCategorySelect();
                renderCategoryList();
                input.value = '';
            } else {
                alert(data.error || 'Failed to add category');
            }
        } catch (e) {
            alert('Failed to add category');
        }
    });

    // Background option chips
    document.querySelectorAll('.option-chip').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var group = btn.closest('.option-row');
            var targetId = btn.getAttribute('data-target');
            var hidden = targetId ? document.getElementById(targetId) : null;
            if (!group || !hidden) return;
            group.querySelectorAll('.option-chip').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            hidden.value = btn.getAttribute('data-value');
        });
    });

    function parseMoneyNumber(value) {
        if (value == null) return null;
        var raw = String(value).trim();
        if (!raw) return null;
        var cleaned = raw.replace(/[, ]+/g, '').replace(/[^\d.-]/g, '');
        if (!cleaned || cleaned === '-' || cleaned === '.' || cleaned === '-.') return null;
        var n = Number(cleaned);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
    }

    function formatNairaLabel(value) {
        var n = parseMoneyNumber(value);
        if (n == null) return String(value || '').trim();
        var hasDecimals = Math.abs(n - Math.round(n)) > 0.0001;
        return '₦' + n.toLocaleString('en-NG', {
            minimumFractionDigits: 0,
            maximumFractionDigits: hasDecimals ? 2 : 0
        });
    }

    function normalizePriceText(value) {
        var raw = String(value || '').trim();
        if (!raw) return '';
        var formatted = formatNairaLabel(raw);
        return formatted || raw;
    }

    function attachPriceInputFormatter(input) {
        if (!input) return;
        input.addEventListener('focus', function() {
            var n = parseMoneyNumber(input.value);
            if (n == null) return;
            input.value = String(n);
        });
        input.addEventListener('blur', function() {
            input.value = normalizePriceText(input.value);
        });
    }

    // Logic to show Thumbnail + Price Input
    document.getElementById('fileInput').onchange = (e) => {
        const container = document.getElementById('priceInputs');
        container.innerHTML = '';
        const files = Array.from(e.target.files);

        files.forEach((file, i) => {
            const row = document.createElement('div');
            row.className = 'price-row';
            const isVideo = (file.type || '').startsWith('video/');
            const media = document.createElement(isVideo ? 'video' : 'img');
            media.className = 'thumb-preview';
            if (isVideo) {
                media.src = URL.createObjectURL(file);
                media.muted = true;
                media.playsInline = true;
                media.preload = 'metadata';
            } else {
                const reader = new FileReader();
                reader.onload = (event) => { media.src = event.target.result; };
                reader.readAsDataURL(file);
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'prices';
            input.placeholder = `Price (e.g. ₦32,000)`;
            input.required = true;
            attachPriceInputFormatter(input);
            row.appendChild(media);
            row.appendChild(input);
            container.appendChild(row);
        });
    };

    document.getElementById('bulkForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('uploadBtn');
        const loader = document.getElementById('loading');
        const originalBtnHtml = btn.innerHTML;
        btn.disabled = true;
        btn.textContent = 'Generating...';
        loader.style.display = 'block';

        Array.from(e.target.querySelectorAll('input[name="prices"]')).forEach(function(inputEl) {
            inputEl.value = normalizePriceText(inputEl.value);
        });
        const categorySelectEl = document.getElementById('categorySelect');
        const selectedCategoryOption = categorySelectEl
            && categorySelectEl.options
            && categorySelectEl.options.length
            ? categorySelectEl.options[categorySelectEl.selectedIndex]
            : null;
        const batchCategoryName = selectedCategoryOption && selectedCategoryOption.value
            ? String(selectedCategoryOption.textContent || '').trim()
            : '';
        const batchSize = (document.getElementById('productSize') && document.getElementById('productSize').value || '').trim();
        const batchColor = (document.getElementById('productColor') && document.getElementById('productColor').value || '').trim();
        const batchQty = (document.getElementById('productQty') && document.getElementById('productQty').value || '').trim();
        const formData = new FormData(e.target);
        formData.append('removeBg', document.getElementById('removeBgToggle').checked);
        formData.append('size', batchSize);
        formData.append('color', batchColor);
        formData.append('qty', batchQty);

        try {
            const res = await fetch('/upload-bulk', { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error((data && data.error) || 'Upload failed');
            }

            uploadQueue = (Array.isArray(data.items) ? data.items : []).map(function(item) {
                if (!item) return item;
                return {
                    ...item,
                    price: normalizePriceText(item.price || ''),
                    categoryName: (item.categoryName || batchCategoryName || '').trim(),
                    size: (item.size || batchSize || '').trim(),
                    color: (item.color || batchColor || '').trim(),
                    qty: (item.qty || batchQty || '').trim()
                };
            });
            currentIndex = 0;
            document.querySelector('body > main').style.display = 'none';
            document.getElementById('resultArea').style.display = 'flex';
            renderStack();
            var toast = document.getElementById('copyToast');
            if (data.dbSaved) {
                toast.textContent = 'Links ready - Saved to Products';
            } else if (data.dbError) {
                toast.textContent = 'Links ready - DB save failed: ' + data.dbError;
            } else {
                toast.textContent = 'Links ready';
            }
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        } catch (err) {
            alert((err && err.message) || 'Upload failed');
        } finally {
            loader.style.display = 'none';
            btn.disabled = false;
            btn.innerHTML = originalBtnHtml;
        }
    };

    function setCardTransform(el, x, rotateDeg) {
        el.style.transform = `translate3d(${x}px, 0, 0) rotate(${rotateDeg}deg)`;
    }

    function updateBackCards(progress) {
        const p = clamp(progress, 0, 1);

        if (backCards.second) {
            const x = 34 - (p * 24);
            const y = 12 - (p * 8);
            const scaleX = 0.95 + (p * 0.04);
            const scaleY = 0.915 + (p * 0.07);
            backCards.second.style.transform = `translate3d(${x}px, ${y}px, 0) scale(${scaleX}, ${scaleY})`;
        }

        if (backCards.third) {
            const x = 62 - (p * 36);
            const y = 24 - (p * 14);
            const scaleX = 0.9 + (p * 0.06);
            const scaleY = 0.83 + (p * 0.1);
            backCards.third.style.transform = `translate3d(${x}px, ${y}px, 0) scale(${scaleX}, ${scaleY})`;
        }
    }

    function bindScrollNav() {
        if (scrollNavBound) return;
        const host = document.querySelector('.stack-wrapper');
        if (!host) return;
        host.addEventListener('wheel', function(e) {
            if (Math.abs(e.deltaY) < 12) return;
            e.preventDefault();
            if (wheelLock) return;
            wheelLock = true;
            if (e.deltaY > 0) goToNext();
            else goToPrev();
            setTimeout(function() { wheelLock = false; }, 190);
        }, { passive: false });
        scrollNavBound = true;
    }

    function renderStack() {
        const container = document.getElementById('cardStack');
        container.innerHTML = '';
        backCards.second = null;
        backCards.third = null;
        const itemsToShow = uploadQueue.slice(currentIndex, currentIndex + 3);
        const total = itemsToShow.length;

        itemsToShow.forEach((item, i) => {
            const card = document.createElement('div');
            const isFront = i === 0;
            card.className = 'product-card' + (total >= 2 && i === 1 ? ' stack-2' : '') + (total >= 3 && i === 2 ? ' stack-3' : '');
            card.style.zIndex = total - 1 - i;
            if (i === 1) backCards.second = card;
            if (i === 2) backCards.third = card;
            const safeBadge = escapeHtml(item.badgeLabel || '');
            const safePrice = escapeHtml(normalizePriceText(item.price || ''));
            const parts = [];
            const s = (v) => (v || '').split(',')[0].trim();
            if (item.categoryName) parts.push(escapeHtml(item.categoryName));
            if (item.size) parts.push('Size: ' + escapeHtml(s(item.size)));
            if (item.color) parts.push('Color: ' + escapeHtml(s(item.color)));
            if (item.qty) parts.push('Qty: ' + escapeHtml(s(item.qty)));
            const metaLine = parts.length ? parts.join(' | ') : 'Product';
            card.innerHTML = `
                <div class="card-image-fill">
                    <img class="card-image-bg" src="${escapeHtml(item.previewUrl)}" alt="" aria-hidden="true">
                    <img class="card-image-main" src="${escapeHtml(item.previewUrl)}" alt="">
                </div>
                <div class="card-top-row">
                    <span class="card-label ${safeBadge ? '' : 'is-empty'}">${safeBadge || 'LABEL'}</span>
                    <svg class="card-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M20.8 5.6a5 5 0 00-7.1 0L12 7.3l-1.7-1.7a5 5 0 00-7.1 7.1L12 21.5l8.8-8.8a5 5 0 000-7.1z"></path>
                    </svg>
                </div>
                <div class="card-bottom-meta">
                    <div class="card-price-inline">${safePrice}</div>
                    <div class="card-name-inline">${metaLine}</div>
                </div>
            `;
            if (isFront) initSwipe(card);
            container.appendChild(card);
        });
        bindScrollNav();
        updateBackCards(0);
        updateUI();
    }

    function escapeHtml(s) {
        if (!s) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function initSwipe(el) {
        function getX(e) {
            if (e.clientX != null) return e.clientX;
            if (e.touches && e.touches[0]) return e.touches[0].clientX;
            if (e.changedTouches && e.changedTouches[0]) return e.changedTouches[0].clientX;
            return drag.currentX;
        }

        function tick() {
            if (!drag.active || !el.parentNode) return;
            const targetX = drag.currentX - drag.startX;
            drag.renderedX += (targetX - drag.renderedX) * 0.34;
            const x = drag.renderedX;
            const rotate = clamp(x / 11, -MAX_ROTATE, MAX_ROTATE);
            setCardTransform(el, x, rotate);
            updateBackCards(clamp(Math.abs(x) / (el.offsetWidth * 0.36), 0, 1));
            drag.raf = requestAnimationFrame(tick);
        }

        function onStart(e) {
            if (drag.active) return;
            if (e.pointerType === 'mouse' && e.button !== 0) return;
            e.preventDefault();
            const now = performance.now();
            const startX = getX(e);
            drag.active = true;
            drag.startX = drag.currentX = startX;
            drag.renderedX = 0;
            drag.lastX = startX;
            drag.lastMoveTime = now;
            drag.velocityX = 0;
            drag.startTime = Date.now();
            el.classList.add('dragging');
            el.style.willChange = 'transform';
            if (el.setPointerCapture && e.pointerId != null) el.setPointerCapture(e.pointerId);
            drag.raf = requestAnimationFrame(tick);
        }

        function onMove(e) {
            if (!drag.active) return;
            if (e.cancelable) e.preventDefault();
            const now = performance.now();
            const nextX = getX(e);
            const dt = Math.max(1, now - drag.lastMoveTime);
            drag.velocityX = (nextX - drag.lastX) / dt;
            drag.lastMoveTime = now;
            drag.lastX = nextX;
            drag.currentX = nextX;
        }

        function onEnd(e) {
            if (!drag.active) return;
            const endX = getX(e);
            drag.currentX = endX;
            const dx = endX - drag.startX;
            const elapsedMs = Math.max(16, Date.now() - drag.startTime);
            const avgVelocity = dx / elapsedMs;
            const velocity = Math.abs(drag.velocityX || avgVelocity);
            const shouldNavigate = Math.abs(dx) > SWIPE_THRESHOLD || velocity > VELOCITY_THRESHOLD;
            const swipeLeft = dx < 0;
            const canGoNext = currentIndex < uploadQueue.length - 1;
            const canGoPrev = currentIndex > 0;

            drag.active = false;
            cancelAnimationFrame(drag.raf);
            el.classList.remove('dragging');
            el.style.willChange = '';

            if (shouldNavigate && ((swipeLeft && canGoNext) || (!swipeLeft && canGoPrev))) {
                const direction = swipeLeft ? -1 : 1;
                const throwX = direction * Math.max(window.innerWidth * 0.92, Math.abs(dx) * THROW_MULT);
                el.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1)';
                setCardTransform(el, throwX, direction * MAX_ROTATE);
                updateBackCards(1);
                setTimeout(() => { if (swipeLeft) goToNext(); else goToPrev(); }, 210);
            } else {
                el.style.transition = 'transform 0.34s cubic-bezier(0.16, 1, 0.3, 1)';
                setCardTransform(el, 0, 0);
                updateBackCards(0);
            }
        }

        if ('PointerEvent' in window) {
            el.addEventListener('pointerdown', onStart, { passive: false });
            el.addEventListener('pointermove', onMove, { passive: false });
            el.addEventListener('pointerup', onEnd, { passive: true });
            el.addEventListener('pointercancel', onEnd, { passive: true });
        } else {
            el.addEventListener('touchstart', onStart, { passive: false });
            el.addEventListener('touchmove', onMove, { passive: false });
            el.addEventListener('touchend', onEnd, { passive: true });
            el.addEventListener('touchcancel', onEnd, { passive: true });
        }
    }

    function goToNext() {
        if (currentIndex < uploadQueue.length - 1) {
            currentIndex++;
            renderStack();
            updateUI();
        }
    }

    function goToPrev() {
        if (currentIndex > 0) {
            currentIndex--;
            renderStack();
            updateUI();
        }
    }

    function copyCurrent() {
        if (currentIndex >= uploadQueue.length) return;
        const item = uploadQueue[currentIndex];
        const text = normalizePriceText(item.price || '') + '\n' + item.link;
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('copyToast');
            toast.textContent = 'Link copied';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1800);
        }).catch(() => {
            const toast = document.getElementById('copyToast');
            toast.textContent = 'Copy failed';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1800);
        });
    }

    async function shareNextStatus() {
        if (currentIndex >= uploadQueue.length) return;
        const item = uploadQueue[currentIndex];
        const text = 'Price: ' + normalizePriceText(item.price || '') + '\n' + item.link;
        const toast = document.getElementById('copyToast');
        const wasLast = currentIndex >= uploadQueue.length - 1;

        try {
            if (navigator.share) {
                await navigator.share({ text });
            } else {
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
            }

            if (!wasLast) {
                currentIndex++;
                renderStack();
            }

            toast.textContent = wasLast
                ? 'Shared final item '
                : `Shared. Next item ${currentIndex + 1} of ${uploadQueue.length}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1800);
        } catch (err) {
            if (err && err.name === 'AbortError') return;
            toast.textContent = 'Share failed';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1800);
        }
    }

    function updateUI() {
        document.getElementById('queueCount').textContent = uploadQueue.length;
        const dotsEl = document.getElementById('progressDots');
        if (dotsEl && uploadQueue.length > 0) {
            dotsEl.innerHTML = '';
            for (let i = 0; i < Math.min(uploadQueue.length, 10); i++) {
                const span = document.createElement('span');
                if (i === currentIndex) span.classList.add('active');
                dotsEl.appendChild(span);
            }
            if (uploadQueue.length > 10) dotsEl.innerHTML = ''; // hide dots if too many
        }
        if (uploadQueue.length && currentIndex < uploadQueue.length) {
            document.getElementById('cardSubtitle').textContent = `Item ${currentIndex + 1} of ${uploadQueue.length} - Scroll or swipe to browse - Tap Share`;
        }
    }

    function parsePriceToKobo(priceStr) {
        if (!priceStr || typeof priceStr !== 'string') return 0;
        const num = ('' + priceStr).replace(/[^\d.]/g, '').trim();
        if (!num) return 0;
        const n = parseFloat(num);
        return isNaN(n) ? 0 : Math.round(n * 100);
    }
    var userSignedIn = <%- JSON.stringify(typeof user !== 'undefined' && !!user) %>;
    function addToCart(item) {
        const raw = localStorage.getItem('wa_cart');
        const items = raw ? JSON.parse(raw) : [];
        const amountKobo = item.amountKobo != null ? Number(item.amountKobo) : parsePriceToKobo(item.price);
        items.push({
            id: item.id || item.link || Math.random().toString(36).slice(2),
            price: normalizePriceText(item.price || '') || 'Contact for price',
            amountKobo: amountKobo,
            link: item.link || '',
            previewUrl: item.previewUrl || ''
        });
        localStorage.setItem('wa_cart', JSON.stringify(items));
        if (userSignedIn) {
            fetch('/api/cart', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: items }), credentials: 'same-origin' }).catch(function() {});
        }
    }
    function updateCartBadge() {
        const el = document.getElementById('cartTabBadge');
        if (!el) return;
        const n = (JSON.parse(localStorage.getItem('wa_cart') || '[]')).length;
        el.textContent = n;
        el.style.display = n ? 'inline-flex' : 'none';
    }
    function addCurrentToCart() {
        if (currentIndex >= uploadQueue.length) return;
        const item = uploadQueue[currentIndex];
        addToCart(item);
        updateCartBadge();
        const toast = document.getElementById('copyToast');
        toast.textContent = 'Added to cart';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1800);
    }

    updateCartBadge();
</script>
</body>
</html>
