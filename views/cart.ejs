<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#f5f5f7">
    <title>Cart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.paystack.co/v2/inline.js"></script>
    <style>
        :root {
            --app-bg: #f5f5f7;
            --surface: #ffffff;
            --surface-secondary: #f5f5f7;
            --separator: rgba(60,60,67,0.08);
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #8e8e93;
            --tint: #007aff;
            --green: #34c759;
            --radius: 20px;
            --tab-height: 52px;
            --header-height: 48px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Outfit', sans-serif; background: var(--app-bg); color: var(--text); min-height: 100dvh; padding-bottom: calc(var(--tab-height) + env(safe-area-inset-bottom)); }
        .app-header { position: sticky; top: 0; z-index: 10; height: calc(var(--header-height) + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top); padding-left: 20px; padding-right: 20px; background: var(--app-bg); display: flex; align-items: center; border-bottom: 0.5px solid var(--separator); }
        .app-title { font-size: 20px; font-weight: 600; }
        .app-content { padding: 16px 20px 24px; max-width: 480px; margin: 0 auto; }
        .cart-list { margin-bottom: 20px; }
        .cart-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--surface); border-radius: var(--radius); margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .cart-item img { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; background: var(--surface-secondary); }
        .cart-item-info { flex: 1; min-width: 0; }
        .cart-item-price { font-weight: 600; font-size: 15px; }
        .cart-item-remove { padding: 6px 12px; font-size: 13px; color: var(--text-tertiary); background: transparent; border: none; cursor: pointer; font-family: inherit; border-radius: 10px; }
        .cart-item-remove:active { background: var(--surface-secondary); }
        .cart-empty { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        .cart-total { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding: 12px 0; border-top: 0.5px solid var(--separator); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 12px 16px; font-size: 16px; border: 0.5px solid var(--separator); border-radius: var(--radius); background: var(--surface); outline: none; }
        .btn-pay { width: 100%; padding: 14px 20px; font-size: 16px; font-weight: 600; color: #fff; background: var(--green); border: none; border-radius: var(--radius); cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pay:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-pay .icon { width: 20px; height: 20px; }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--tab-height) + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); background: rgba(255,255,255,0.92); backdrop-filter: saturate(180%) blur(20px); border-top: 0.5px solid var(--separator); display: flex; z-index: 50; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; text-decoration: none; color: var(--text-tertiary); font-size: 10px; font-weight: 500; min-height: 44px; }
        .tab-item.active { color: var(--tint); }
        .tab-item svg { width: 22px; height: 22px; }
        .cart-badge {
            position: absolute;
            top: -2px;
            left: calc(50% + 12px);
            transform: translateX(-50%);
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            background: var(--tint);
            border-radius: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 1;
        }
        .tab-item-wrap { position: relative; }
    </style>
</head>
<body>

<header class="app-header">
    <h1 class="app-title">Cart</h1>
</header>

<main class="app-content">
    <div id="cartList" class="cart-list"></div>
    <div id="cartEmpty" class="cart-empty" style="display:none;">
        <p style="font-size:18px;font-weight:600;margin-bottom:8px;">Your cart is empty</p>
        <p style="font-size:15px;color:var(--text-tertiary);">Add items from Products to checkout.</p>
        <a href="/products" style="display:inline-block;margin-top:20px;padding:12px 24px;background:var(--tint);color:#fff;border-radius:var(--radius);font-weight:600;text-decoration:none;">Browse products</a>
    </div>
    <div id="cartCheckout" style="display:none;">
        <div class="cart-total" id="cartTotal">Total: ₦0</div>
        <div class="form-group">
            <label for="customerEmail">Email</label>
            <input type="email" id="customerEmail" placeholder="you@example.com" required>
        </div>
        <button type="button" class="btn-pay" id="payBtn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
            Pay with Paystack
        </button>
    </div>
</main>

<nav class="tab-bar">
    <a href="/" class="tab-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg><span>Studio</span></a>
    <a href="/products" class="tab-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><path d="M3 6h18M16 10a4 4 0 01-8 0"/></svg><span>Products</span></a>
    <a href="/cart" class="tab-item active tab-item-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg><span>Cart</span><span class="cart-badge" id="cartBadge">0</span></a>
</nav>

<script>
(function() {
    var PAYSTACK_PUBLIC = <%- JSON.stringify(paystackPublicKey || '') %>;

    function parsePriceToKobo(priceStr) {
        if (!priceStr || typeof priceStr !== 'string') return 0;
        var num = priceStr.replace(/[^\d.]/g, '').trim();
        if (!num) return 0;
        var n = parseFloat(num);
        return isNaN(n) ? 0 : Math.round(n * 100);
    }

    function Cart() {
        this.storageKey = 'wa_cart';
        this._items = [];
        this.load();
    }
    Cart.prototype.load = function() {
        try {
            var raw = localStorage.getItem(this.storageKey);
            this._items = raw ? JSON.parse(raw) : [];
        } catch (e) { this._items = []; }
        return this;
    };
    Cart.prototype.save = function() {
        localStorage.setItem(this.storageKey, JSON.stringify(this._items));
        return this;
    };
    Cart.prototype.add = function(item) {
        var id = item.id || item.link || Math.random().toString(36).slice(2);
        var amountKobo = Number(item.amountKobo) || parsePriceToKobo(item.price);
        this._items.push({
            id: id,
            price: item.price || 'Contact for price',
            amountKobo: amountKobo,
            link: item.link || '',
            previewUrl: item.previewUrl || ''
        });
        return this.save();
    };
    Cart.prototype.remove = function(id) {
        this._items = this._items.filter(function(it) { return it.id !== id; });
        return this.save();
    };
    Cart.prototype.getItems = function() { return this._items.slice(); };
    Cart.prototype.getTotalKobo = function() {
        return this._items.reduce(function(s, it) { return s + (it.amountKobo || 0); }, 0);
    };
    Cart.prototype.clear = function() { this._items = []; return this.save(); };
    Cart.prototype.count = function() { return this._items.length; };

    var cart = new Cart();

    function formatNaira(kobo) {
        return '₦' + (kobo / 100).toLocaleString();
    }

    function render() {
        var list = document.getElementById('cartList');
        var empty = document.getElementById('cartEmpty');
        var checkout = document.getElementById('cartCheckout');
        var totalEl = document.getElementById('cartTotal');
        var badge = document.getElementById('cartBadge');

        var items = cart.getItems();
        badge.textContent = items.length;

        if (items.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            checkout.style.display = 'none';
            return;
        }
        empty.style.display = 'none';
        checkout.style.display = 'block';
        totalEl.textContent = 'Total: ' + formatNaira(cart.getTotalKobo());

        list.innerHTML = items.map(function(it) {
            return '<div class="cart-item" data-id="' + it.id + '">' +
                (it.previewUrl ? '<img src="' + it.previewUrl + '" alt="">' : '') +
                '<div class="cart-item-info"><div class="cart-item-price">' + it.price + '</div></div>' +
                '<button type="button" class="cart-item-remove" data-id="' + it.id + '">Remove</button></div>';
        }).join('');

        list.querySelectorAll('.cart-item-remove').forEach(function(btn) {
            btn.onclick = function() {
                cart.remove(btn.getAttribute('data-id'));
                render();
            };
        });
    }

    document.getElementById('payBtn').onclick = function() {
        var email = (document.getElementById('customerEmail').value || '').trim();
        if (!email) { alert('Please enter your email'); return; }
        var items = cart.getItems();
        if (items.length === 0) { alert('Cart is empty'); return; }
        var totalKobo = cart.getTotalKobo();
        if (totalKobo < 100) { alert('Minimum amount is ₦1'); return; }

        var btn = document.getElementById('payBtn');
        btn.disabled = true;

        fetch('/api/payment/initialize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: email,
                items: items.map(function(it) { return { id: it.id, price: it.price, amountKobo: it.amountKobo }; })
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Failed to initialize payment');
            if (!PAYSTACK_PUBLIC || typeof window.PaystackPop === 'undefined') {
                window.location.href = data.authorizationUrl;
                return;
            }
            var paystackInstance = new window.PaystackPop();
            paystackInstance.newTransaction({
                key: PAYSTACK_PUBLIC,
                email: email,
                amount: data.amountKobo,
                reference: data.reference,
                onSuccess: function(response) {
                    fetch('/api/payment/verify?reference=' + encodeURIComponent(response.reference))
                        .then(function(r) { return r.json(); })
                        .then(function(v) {
                            if (v.success) {
                                cart.clear();
                                render();
                                alert('Payment successful!');
                            }
                            btn.disabled = false;
                        });
                },
                onCancel: function() { btn.disabled = false; }
            });
        })
        .catch(function(err) {
            alert(err.message || 'Payment failed');
            btn.disabled = false;
        });
    };

    render();
    window.Cart = Cart;
    window.parsePriceToKobo = parsePriceToKobo;
})();
</script>
</body>
</html>
